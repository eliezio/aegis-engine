# ============LICENSE_START=======================================================
#  Copyright (C) 2019 The Nordix Foundation. All rights reserved.
# ================================================================================
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# SPDX-License-Identifier: Apache-2.0
# ============LICENSE_END=========================================================

heat_template_version: 2017-02-24

description: Kubespray cluster template to deploy ONAP

parameters:
  # parameters for k8s master instances
  no_of_master_nodes:
    type: number
    label: No of k8s master nodes
    description: Number of master nodes in k8s cluster

  master_image:
    type: string
    label: Image name or ID
    description: Image to use for k8s master instances

  master_flavor:
    type: string
    label: Flavor
    description: Flavor to use for k8s master instances

  # parameters for k8s worker instances
  no_of_worker_nodes:
    type: number
    label: No of k8s worker nodes
    description: Number of worker nodes in k8s cluster

  worker_image:
    type: string
    label: Image name or ID
    description: Image to use for k8s worker instances

  worker_flavor:
    type: string
    label: Flavor
    description: Flavor to use for k8s worker instances

  # common parameters
  keypair:
    type: string
    label: Keypair
    description: Keypair to use on instances

  public_network:
    type: string
    label: Public Network
    description: Public network

  dns_nameservers:
    type: comma_delimited_list
    label: DNS nameservers
    description: DNS nameservers

resources:
  # create private network subnet
  private_network:
    type: OS::Neutron::Net
    properties:
      name:
        list_join: ['.', ['network', { get_param: 'OS::stack_name' } ]]

  private_subnet:
    type: OS::Neutron::Subnet
    properties:
      name:
        list_join:  ['.', ['subnet', { get_param: 'OS::stack_name' } ]]
      network_id: { get_resource: private_network }
      cidr: 10.1.0.0/24
      dns_nameservers: { get_param: dns_nameservers }

  router:
    type: OS::Neutron::Router
    properties:
      name:
        list_join:  ['.', ['router', { get_param: 'OS::stack_name' } ]]
      external_gateway_info:
        network: { get_param: public_network }

  router_interface:
    type: OS::Neutron::RouterInterface
    properties:
      router_id: { get_resource: router }
      subnet: { get_resource: private_subnet }

  # create master nodes
  master_nodes:
    type: OS::Heat::ResourceGroup
    properties:
      count: { get_param: no_of_master_nodes }
      resource_def:
        type: heat-server.yaml
        properties:
          instance_name:
            list_join: ['.', ['master%index%', { get_param: 'OS::stack_name' } ]]
          image: { get_param: master_image }
          flavor: { get_param: master_flavor }
          keypair: { get_param: keypair }
          private_network: { get_resource: private_network }

  # create worker nodes
  worker_nodes:
    type: OS::Heat::ResourceGroup
    properties:
      count: { get_param: no_of_worker_nodes }
      resource_def:
        type: heat-server.yaml
        properties:
          instance_name:
            list_join: ['.', ['worker%index%', { get_param: 'OS::stack_name' } ]]
          image: { get_param: worker_image }
          flavor: { get_param: worker_flavor }
          keypair: { get_param: keypair }
          private_network: { get_resource: private_network }

outputs:
  master_ip:
    value: {get_attr: [master_nodes, instance_ip]}
  worker_ip:
    value: {get_attr: [worker_nodes, instance_ip]}

# vim: set ts=2 sw=2 expandtab:
